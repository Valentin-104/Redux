---
title: Building Multiturn Conversations (Chat) Using Gemni API
date: '2023-12-23'
tags: ['JavaScript', 'React', 'Next.js', 'Gemini', 'project']
draft: false
summary: Geminië¥¼ APIë¥¼ í™œìš©í•˜ì—¬ ë©€í‹°í„´ ëŒ€í™” ë§Œë“¤ê¸° (ì±„íŒ…)
---

[Gemini](https://ai.google.dev) APIë¥¼ ì‚¬ìš©í•˜ë©´ **Google**ì˜ ìµœì‹  ìƒì„±í˜• AI ëª¨ë¸ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ *ChatGPT*ê°™ì€ ì±—ë´‡ì„ ë§Œë“¤ê³ ì í•˜ì˜€ë‹¤. ë§í¬ë¡œ ë“¤ì–´ê°€ì„œ íŠœí† ë¦¬ì–¼ì„ ì‚´í´ë³´ê³  ì§„í–‰í–ˆë‹¤.

1. ë¨¼ì € API í‚¤ë¥¼ ë°›ì•„ `.env.local` íŒŒì¼ì— ì ëŠ”ë‹¤.

2. `lib` í´ë” ì•ˆì— `utils.ts` íŒŒì¼ì„ ë§Œë“¤ê³ , ìƒì„± ëª¨ë¸ì„ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í•œë‹¤.

    ```ts:lib/utils.ts
    export function startChat() {
      const genAI = new GoogleGenerativeAI(
        process.env.NEXT_PUBLIC_GEMINI_API_KEY as string // íƒ€ì… ì—ëŸ¬ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ type assertion
      );
      const model = genAI.getGenerativeModel({ model: 'gemini-pro' }); // gemini-pro ëª¨ë¸ ì‚¬ìš©

      const chat = model.startChat({
        generationConfig: {
          maxOutputTokens: 2048, 
          // Max output token(ìµœëŒ€ ì¶œë ¥ í† í°): ì‘ë‹µì—ì„œ ìƒì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í† í° ìˆ˜ë¥¼ ì§€ì •. í† í° 1ê°œëŠ” ì•½ 4ì(ì˜ë¬¸ ê¸°ì¤€). 100ê°œ í† í°ì€ ì•½ 60~80ê°œ ë‹¨ì–´ì— í•´ë‹¹
        },
      });

      return chat;
    }
    ```

3. API ë¬¸ì„œì— ìˆëŠ” [ìƒ˜í”Œ ì•±](https://github.com/google/generative-ai-js/tree/main/samples/web)ì„ ì°¸ê³ í•˜ì—¬, ì‘ë‹µì„ ë°›ì•„ì„œ ì±„íŒ… ê¸°ë¡ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤.
    
    ```ts:lib/utils.ts
    export async function updateUI({
      setModelParts,
      chatHistory,
      setChatHistory,
      getResult,
      streaming,
    }: chatParams) {
      try {
        const result = await getResult();
    
        // ìŠ¤íŠ¸ë¦¬ë°ì„ ì‚¬ìš©í•´ ë” ë¹ ë¥´ê²Œ ìƒí˜¸ì‘ìš©
        if (streaming) {
          // to do later...
        } 
        // ìŠ¤íŠ¸ë¦¬ë°ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì‘ë‹µì„ í•œ ë²ˆì— ë‹¤ ë°›ì•„ì„œ ëª¨ë¸ ë©”ì‹œì§€ ìƒíƒœ ì—…ë°ì´íŠ¸ 
        else {
          const response = await result.response;

          setModelParts(response.text());
        }
      } catch (error) {
        console.error(error);
      }
    }
    ```

4. `form`ì˜ `submit` ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì¸ `handleSubmit`ì—ì„œ í•¨ìˆ˜ `startChat`, `updateUI`ë¥¼ ì‹¤í–‰í•œë‹¤.

    ```tsx:components/chat.tsx
    'use client';
    
    import { FormEvent, useState } from 'react';
    import { startChat, updateUI } from '@/lib/utils';
    import { toast } from 'sonner';
    import { Send } from 'lucide-react';
    import { Button } from './ui/button';
    import { Msg } from '@/lib/types';
    import TextareaAutosize from 'react-textarea-autosize';
    import Loader from './loader';
    import { ButtonScrollToBottom } from './button-scroll-to-bottom';
    import EmptyScreen from './empty-screen';
    import ChatList from './chat-list';
    import ChatScrollAnchor from './chat-scroll-anchor';
    
    export default function Chat() {  
      const [userParts, setUserParts] = useState<string>('');
      const [modelParts, setModelParts] = useState<string>('');
      const [chatHistory, setChatHistory] = useState<Msg[]>([]);
      const [pending, setPending] = useState<boolean>(false);
    
      const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        if (!userParts.trim()) {
          return;
        }
        setUserParts('');
        setPending(true);
    
        const userMsg = {
          role: 'user',
          parts: userParts,
        };
        const modelMsg = {
          role: 'model',
          parts: modelParts,
        };
    
        const updatedChatHistory = [...chatHistory, userMsg, modelMsg];
        setChatHistory(updatedChatHistory);
    
        const chat = startChat();
        await updateUI({
          chatHistory: updatedChatHistory,
          setChatHistory,
          setModelParts,
          getResult: () => chat.sendMessageStream(userParts),
          streaming: false, // ìŠ¤íŠ¸ë¦¬ë°ì„ ì‚¬ìš©í•  ì‹œ true
        });
    
        setPending(false);
        setModelParts('');
        toast('ğŸ¥³ Gemini responded!');
      };
    
      return (
        <div className='flex flex-col justify-between min-h-screen pt-20'>
          {chatHistory.length ? (
            <>
              <ChatList
                chatHistory={chatHistory}
                pending={pending}
                profilePic={profilePic}
              />
              <ChatScrollAnchor />
            </>
          ) : (
            <EmptyScreen setUserParts={setUserParts} />
          )}
    
          <form onSubmit={handleSubmit} className='sticky bottom-0 mt-24'>
            <section className='relative bg-background h-4'>
              <ButtonScrollToBottom />
              <TextareaAutosize
                rows={1}
                className='absolute bottom-3 w-full resize-none bg-secondary placeholder:text-primary/50 text-primary min-h-fit max-h-48 focus-within:outline-none pl-6 py-5 pr-16 rounded-lg'
                placeholder='Message Gemini...'
                autoFocus
                value={userParts}
                onChange={(e) => setUserParts(e.target.value)}
              />
    
              <Button
                type='submit'
                size='icon'
                className='absolute right-6 bottom-[26px]'
                disabled={pending || !userParts.trim()}
              >
                {pending ? (
                  <Loader className='w-6 h-6 border-secondary/50 border-t-secondary' />
                ) : (
                  <Send className='w-6 h-6' />
                )}
              </Button>
            </section>
          </form>
        </div>
      );
    }
    ```