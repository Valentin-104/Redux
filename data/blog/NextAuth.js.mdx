---
title: NextAuth.js
date: '2023-02-09'
tags: ['NextAuth.js', 'Next.js', 'auth' ,'OAuth']
draft: false
summary: NextAuth.js를 활용한 Open Authorization
---

- Next.js에서 auth를 구현하기 위한 open source library인 NextAuth.js를 활용해보았다.

  > [NextAuth.js](https://next-auth.js.org/)

- 공식 홈페이지에 들어가보면 바로 코드가 나와있다. 크게 3가지 단계로 나뉜다.

1. 먼저 `/pages/api/auth` 폴더로 가서 `[...nextauth].ts` 라는 파일을 만들고, 원하는 OAuth provider를 골라 코드를 작성한다. 
    
    
    ```ts:pages/api/auth/[...nextauth].ts
    import NextAuth from 'next-auth'
    import AppleProvider from 'next-auth/providers/apple'
    import FacebookProvider from 'next-auth/providers/facebook'
    import GoogleProvider from 'next-auth/providers/google'
    import EmailProvider from 'next-auth/providers/email'
    
    export default NextAuth({
      providers: [
        // OAuth authentication providers...
        AppleProvider({
          clientId: process.env.APPLE_ID,
          clientSecret: process.env.APPLE_SECRET
        }),
        FacebookProvider({
          clientId: process.env.FACEBOOK_ID,
          clientSecret: process.env.FACEBOOK_SECRET
        }),
        GoogleProvider({
          clientId: process.env.GOOGLE_ID,
          clientSecret: process.env.GOOGLE_SECRET
        }),
        // Passwordless / email sign in
        EmailProvider({
          server: process.env.MAIL_SERVER,
          from: 'NextAuth.js <no-reply@example.com>'
        }),
      ]
    })
    ```
    
    나는 google로만 OAuth를 진행하고 싶었다.
    
    ```ts:pages/api/auth/[...nextauth].ts
    import NextAuth from 'next-auth';
    import GoogleProvider from 'next-auth/providers/google';
    
    export default NextAuth({
      providers: [
        GoogleProvider({
          clientId: process.env.GOOGLE_ID!,
          clientSecret: process.env.GOOGLE_SECRET!,
        }),
      ],
    });
    ```
    
    여기서 `GOOGLE_ID`와 `GOOGLE_SECRET`은 구글 클라우드에서 웹 앱을 만든 후, API 및 서비스 > 사용자 인증 정보 > OAuth 2.0 클라이언트 ID로 가면 확인할 수 있다.

    > [Cloud Computing Services](https://cloud.google.com/)

2. `/pages/_app.tsx` 로 가서 `<Component>` 를 `<SessionProvider>` 로 감싸주어 auth context를 설정한다. 
    
    ```tsx:pages/_app.tsx
    import '@/styles/globals.css';
    import type { AppProps } from 'next/app';
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
    import { RecoilRoot } from 'recoil';
    import { SessionProvider } from 'next-auth/react';
    
    const queryClient = new QueryClient();
    
    export default function App({
      Component,
      pageProps: { session, ...pageProps },
    }: AppProps) {
      return (
        <SessionProvider session={session}>
          <RecoilRoot>
            <QueryClientProvider client={queryClient}>
              <Component {...pageProps} />
            </QueryClientProvider>
          </RecoilRoot>
        </SessionProvider>
      );
    }
    ```
    
3. 이제 자신이 원하는 페이지에서 `useSession()` hook을 통해 session을 이용하고, `signIn` , `signOut`  method를 통해 로그인/로그아웃을 할 수 있다. 
   
    ```tsx:pages/index.tsx

    import { useSession, signIn, signOut } from "next-auth/react"
    
    export default function Home() {
      const { status, data: session } = useSession();
    
      if (status === 'loading') return <Loader />; // 로딩중
    
      if (status === 'authenticated') // 로그인 상태
        return (
          <>
            <Head>
              <title>Create Next App</title>
              <meta name='description' content='Generated by create next app' />
              <meta name='viewport' content='width=device-width, initial-scale=1' />
              <link rel='icon' href='/favicon.ico' />
            </Head>
            <main>
    	        Signed in as {session.user.email} <br/>
    			    <button onClick={() => signOut()}>Sign out</button>
            </main>
          </>
        );
    	
        // 로그아웃 상태
        return (
          <button onClick={() => signIn('google')} className='bg-white'>
            Sign in
          </button>
        );
    }
    ```
    
4. 이렇게 하고 로그인을 시도했더니 이런 페이지로 리디렉트되었다. 

    ![error](/static/images/error.png)
  

    이를 해결하기 위해서, error details를 클릭해봤다. 그랬더니 이런 창이 떴다.

    ![redirect_uri_mismatch](/static/images/redirect_uri_mismatch.png)

    내용인 즉슨, 아까 앱을 만들었던 구글 클라우드로 가서 redirect uri를 등록하라는 것이다. `http://localhost:3000/api/auth/callback/google`로 등록하였다. 

5. 해결됐다!! 👏👏🎉🎉
    
    ![success](/static/images/success.png)