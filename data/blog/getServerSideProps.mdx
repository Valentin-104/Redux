---
title: getServerSideProps function
date: '2023-03-08'
tags: ['Next.js', 'SSR', 'ChatGPT']
draft: false
summary: getServerSideProps 함수에서 다수의 API 요청 보내기
---

- TMDB API를 이용하여 Netflix처럼 여러가지 장르의 영화를 SSR로 불러오고 싶었다. 그런데 각 장르마다 API endpoint가 다르기 때문에 한 번의 API 요청으로는 모든 장르를 불러올 수가 없었다.
- 그래서 해당하는 장르의 enpoint에 맞게 여러가지 API 요청을 보내야 하는데, 물론 일일이 보내면 되기는 하지만, 뭔가 비효율적인 거 같고 더 좋은 방법이 있을 거 같았다.
- ChatGPT에게 물어보았다.

  > you can use Promise.all to asynchronously fetch data from multiple endpoints.

- `Promise.all` 을 쓰라는 것이다. 그의 코드.

  ```ts
  export async function getServerSideProps() {
    const [data1, data2] = await Promise.all([
      fetch('https://api.example.com/data1'),
      fetch('https://api.example.com/data2')
    ]);
  
    const json1 = await data1.json();
    const json2 = await data2.json();
  
    return {
      props: {
        data1: json1,
        data2: json2
      }
    };
  }
  ```

- 이를 적용하여 코드를 작성해보았다.

  ```tsx:pages/index.tsx
  
  import {
    getActionMovies,
    getComedyMovies,
    getDocumentaries,
    getHorrorMovies,
    getRomanceMovies,
    getTopRatedMovies,
    getTrendingMovies,
    getUpcomingMovies,
  } from './api/tmdbApi';
  
  export interface Movie {
    title: string;
    backdrop_path: string;
    media_type?: string;
    release_date?: string;
    first_air_date: string;
    genre_ids: number[];
    id: number;
    name: string;
    origin_country: string[];
    original_language: string;
    original_name: string;
    overview: string;
    popularity: number;
    poster_path: string;
    vote_average: number;
    vote_count: number;
  }
  
  interface Movies {
    nowPlaying: Movie[];
    trending: Movie[];
    topRated: Movie[];
    romance: Movie[];
    horror: Movie[];
    comedy: Movie[];
    documentaries: Movie[];
    action: Movie[];
  }
  
  export default function Home({
    nowPlaying,
    trending,
    topRated,
    romance,
    horror,
    documentaries,
    comedy,
    action,
  }: Movies) {
    return (
      <>
        <Head>
          <title>Create Next App</title>
          <meta name='description' content='Generated by create next app' />
          <meta name='viewport' content='width=device-width, initial-scale=1' />
          <link rel='icon' href='/favicon.ico' />
        </Head>
        <main className='bg-black'>
          <Header />
          <Banner nowPlaying={nowPlaying} />
          <section className='p-8 space-y-10'>
            <MovieGallery title='Trending' movies={trending} />
            <MovieGallery title='Top Rated' movies={topRated} />
            <MovieGallery title='Romance' movies={romance} />
            <MovieGallery title='Horror' movies={horror} />
            <MovieGallery title='Documentary' movies={documentaries} />
            <MovieGallery title='Comedy' movies={comedy} />
            <MovieGallery title='Action' movies={action} />
          </section>
        </main>
      </>
    );
  }
  
  export async function getServerSideProps() {
    const [
      nowPlaying,
      trending,
      topRated,
      romance,
      horror,
      documentaries,
      comedy,
      action,
    ] = await Promise.all([
      getUpcomingMovies(),
      getTrendingMovies(),
      getTopRatedMovies(),
      getRomanceMovies(),
      getHorrorMovies(),
      getDocumentaries(),
      getComedyMovies(),
      getActionMovies(),
    ]);
  
    return {
      props: {
        nowPlaying: nowPlaying.results,
        trending: trending.results,
        topRated: topRated.results,
        romance: romance.results,
        horror: horror.results,
        documentaries: documentaries.results,
        comedy: comedy.results,
        action: action.results,
      },
    };
  }
  ```

- 다만 `fetch`대신 `axios`를 쓰기 때문에 `json()` method를 쓰지 않았고, API로부터 오는 데이터 객체의 key중 results만 쓰고 싶었기 때문에 `getServerSideProps` 함수에서 results를 props로 return했다. 이렇게 하니까 모든 장르의 영화들을 SSR로 한 번에 불러올 수 있었다.